<?php
include '../includes/config.php';

session_start();

// Check if user is logged in
if (!isset($_SESSION['user_id']) || !isset($_SESSION['role'])) {
    http_response_code(401); // Unauthorized
    echo json_encode(['error' => 'User not logged in']);
    exit;
}

$user_id = $_SESSION['user_id'];
$role = $_SESSION['role'];

// Get pagination variables from GET request
$page = isset($_GET['page']) ? (int)$_GET['page'] : 1;
$limit = isset($_GET['limit']) ? (int)$_GET['limit'] : 5; // Default to 5 notifications per page
$offset = ($page - 1) * $limit; // Calculate the offset for pagination

try {
    // Prepare query to fetch the total number of notifications and unread count
    $count_query = "SELECT 
                        COUNT(*) AS total,
                        SUM(CASE WHEN is_read = 0 THEN 1 ELSE 0 END) AS unread_count
                    FROM notifications 
                    WHERE recipient_id = ?";
    $count_stmt = $conn->prepare($count_query);
    $count_stmt->bind_param('i', $user_id);
    $count_stmt->execute();
    $count_result = $count_stmt->get_result();
    $counts = $count_result->fetch_assoc();
    $total_notifications = $counts['total'];
    $unread_count = $counts['unread_count'];

    // Add new notifications to the unread count
    if ($role == 'admin') {
        // Count pending job approval requests for admins
        $query = "SELECT COUNT(*) AS pending_approvals
                  FROM jobs j
                  WHERE j.status = 'pending'";
        $stmt = $conn->prepare($query);
        $stmt->execute();
        $result = $stmt->get_result();
        $pending_approvals = $result->fetch_assoc()['pending_approvals'];
        $unread_count += $pending_approvals; // Add to unread count
    } elseif ($role == 'employer') {
        // Count job post status updates for employers
        $query = "SELECT COUNT(*) AS status_updates
                  FROM jobs j
                  WHERE j.employer_id = ? AND j.status IN ('approved', 'rejected')";
        $stmt = $conn->prepare($query);
        $stmt->bind_param('i', $user_id);
        $stmt->execute();
        $result = $stmt->get_result();
        $status_updates = $result->fetch_assoc()['status_updates'];
        $unread_count += $status_updates; // Add to unread count
    }

    $total_pages = ceil($total_notifications / $limit); // Calculate total pages

    // Prepare query to fetch notifications for the current page
    $notifications = [];

    // Existing logic for fetching notifications
    if ($role == 'admin') {
        // Admin view: List all applicants for all jobs
        $query = "SELECT n.id, n.job_id, CONCAT(u.first_name, ' ', u.last_name) AS applicant_name, j.title AS job_name, a.status AS application_status, n.is_read, n.created_at, 
                  CONCAT('Application from ', u.first_name, ' ', u.last_name, ' for job ', j.title) AS message
                  FROM notifications n
                  JOIN users u ON n.sender_id = u.id
                  JOIN jobs j ON n.job_id = j.id
                  LEFT JOIN applications a ON n.job_id = a.job_id AND a.user_id = n.recipient_id
                  WHERE n.recipient_id = ? ORDER BY n.created_at DESC LIMIT ?, ?";
        $stmt = $conn->prepare($query);
        $stmt->bind_param('iii', $user_id, $offset, $limit);

    } elseif ($role == 'employer') {
        // Employer view: Notifications about applications for their own jobs
        $query = "SELECT n.id, n.job_id, CONCAT(u.first_name, ' ', u.last_name) AS applicant_name, j.title AS job_name, a.status AS application_status, n.is_read, n.created_at, 
                  CONCAT('Application from ', u.first_name, ' ', u.last_name, ' for job ', j.title) AS message
                  FROM notifications n
                  JOIN users u ON n.sender_id = u.id
                  JOIN jobs j ON n.job_id = j.id
                  LEFT JOIN applications a ON n.job_id = a.job_id AND a.user_id = n.recipient_id
                  WHERE n.recipient_id = ? AND j.employer_id = ? ORDER BY n.created_at DESC LIMIT ?, ?";
        $stmt = $conn->prepare($query);
        $stmt->bind_param('iiii', $user_id, $user_id, $offset, $limit);

    } else {
        // User view: Notifications about their job applications
        $query = "SELECT n.id, n.job_id, j.title AS job_name, a.status AS application_status, n.is_read, n.created_at, 
                  CONCAT('Your application for ', j.title, ' has been ', a.status) AS message
                  FROM notifications n
                  JOIN jobs j ON n.job_id = j.id
                  LEFT JOIN applications a ON n.job_id = a.job_id AND a.user_id = n.recipient_id
                  WHERE n.recipient_id = ? ORDER BY n.created_at DESC LIMIT ?, ?";
        $stmt = $conn->prepare($query);
        $stmt->bind_param('iii', $user_id, $offset, $limit);
    }

    $stmt->execute();
    $result = $stmt->get_result();

    while ($row = $result->fetch_assoc()) {
        $notifications[] = $row;
    }

    // New logic for job approval requests and job post status updates
    if ($role == 'admin') {
        // Fetch job approval requests for admins
        $query = "SELECT j.id AS job_id, j.title AS job_name, CONCAT(u.first_name, ' ', u.last_name) AS employer_name, j.status, j.created_at
                  FROM jobs j
                  JOIN users u ON j.employer_id = u.id
                  WHERE j.status = 'pending'";
        $stmt = $conn->prepare($query);
        $stmt->execute();
        $result = $stmt->get_result();

        while ($row = $result->fetch_assoc()) {
            $notifications[] = [
                'id' => null, // No notification ID since this is not from the notifications table
                'job_id' => $row['job_id'],
                'job_name' => $row['job_name'],
                'message' => "Employer {$row['employer_name']} has requested approval for the job {$row['job_name']}",
                'is_read' => 0, // Assume unread
                'created_at' => $row['created_at']
            ];
        }

    } elseif ($role == 'employer') {
        // Fetch job post status updates for employers
        $query = "SELECT j.id AS job_id, j.title AS job_name, j.status, j.created_at
                  FROM jobs j
                  WHERE j.employer_id = ? AND j.status IN ('approved', 'rejected')";
        $stmt = $conn->prepare($query);
        $stmt->bind_param('i', $user_id);
        $stmt->execute();
        $result = $stmt->get_result();

        while ($row = $result->fetch_assoc()) {
            $notifications[] = [
                'id' => null, // No notification ID since this is not from the notifications table
                'job_id' => $row['job_id'],
                'job_name' => $row['job_name'],
                'message' => "Your job post '{$row['job_name']}' has been {$row['status']}.",
                'is_read' => 0, // Assume unread
                'created_at' => $row['created_at']
            ];
        }
    }

    // Sort notifications by creation date (newest first)
    usort($notifications, function ($a, $b) {
        return strtotime($b['created_at']) - strtotime($a['created_at']);
    });

    // Apply pagination to the combined notifications
    $paginated_notifications = array_slice($notifications, $offset, $limit);

    // Return notifications, total pages, and unread count
    echo json_encode([
        'notifications' => $paginated_notifications,
        'totalPages' => $total_pages,
        'unreadCount' => $unread_count
    ]);

} catch (Exception $e) {
    http_response_code(500); // Internal Server Error
    echo json_encode(['error' => 'Database error: ' . $e->getMessage()]);
}
?>